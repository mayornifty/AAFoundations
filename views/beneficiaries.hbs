<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beneficiaries</title>
    <!-- Include jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <!-- Include Bootstrap CSS for styling -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Include DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.css">
</head>
<body>
    <div class="container mt-5">
        <h1>Beneficiaries</h1>

        <!-- Add Beneficiary Button -->
        <button type="button" class="btn btn-primary mb-3" data-toggle="modal" data-target="#editBeneficiaryModal">Add New Beneficiary</button>

        <!-- Edit Beneficiary Modal -->
        <div class="modal fade" id="editBeneficiaryModal" tabindex="-1" role="dialog" aria-labelledby="editBeneficiaryModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <form id="beneficiaryForm" class="needs-validation" novalidate>
                        <div class="modal-header">
                            <h5 class="modal-title" id="editBeneficiaryModalLabel">Edit Beneficiary</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <!-- Hidden ID Field for Edit -->
                            <input type="hidden" id="editId" name="editId">
                            <!-- Name -->
                            <div class="form-group">
                                <label for="name">Name</label>
                                <input type="text" class="form-control" id="name" name="name" required>
                                <div class="invalid-feedback">Please enter a valid name.</div>
                            </div>
                            <!-- Phone Number -->
                            <div class="form-group">
                                <label for="phone_no">Phone Number</label>
                                <input type="tel" class="form-control" id="phone_no" name="phone_no" pattern="[0-9]{11}" required>
                                <div class="invalid-feedback">Please enter a valid 11-digit phone number.</div>
                            </div>
                            <!-- Contact Address -->
                            <div class="form-group">
                                <label for="contact_address">Contact Address</label>
                                <input type="text" class="form-control" id="contact_address" name="contact_address" required>
                                <div class="invalid-feedback">Please enter a contact address.</div>
                            </div>
                            <!-- Email Address -->
                            <div class="form-group">
                                <label for="email_address">Email Address</label>
                                <input type="email" class="form-control" id="email_address" name="email_address" required>
                                <div class="invalid-feedback">Please enter a valid email address.</div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <hr>

        <!-- Beneficiaries Table -->
        <h2>All Beneficiaries</h2>
        <table id="beneficiariesTable" class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Phone Number</th>
                    <th>Contact Address</th>
                    <th>Email Address</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <!-- Beneficiaries will be inserted here -->
            </tbody>
        </table>
    </div>

    <!-- Include Bootstrap JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- Include DataTables JS -->
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.js"></script>
    <!-- JavaScript for Handling Form Submissions and Table Population -->
    <script>
        // Document ready function
        $(document).ready(function() {
            // Initialize DataTable
            var table = $('#beneficiariesTable').DataTable({
                columnDefs: [{
                    targets: -1,
                    orderable: false,
                    searchable: false,
                }]
            });

            // Load beneficiaries on page load
            loadBeneficiaries();

            // Clear invalid feedback on input
            $('#beneficiaryForm input').on('input', function() {
                $(this).removeClass('is-invalid');
                $(this).siblings('.invalid-feedback').text('');
            });

            // Submit Form Handling (Example using jQuery)
            $('#beneficiaryForm').submit(function(event) {
                event.preventDefault();
                if (!this.checkValidity()) {
                    event.stopPropagation();
                    return;
                }
                var formData = $(this).serialize();
                var url = '/api/beneficiaries';
                var method = 'POST';
                var editId = $('#editId').val();
                if (editId) {
                    url += '/' + editId;
                    method = 'PUT';
                }
                $.ajax({
                    type: method,
                    url: url,
                    data: formData,
                    success: function(response) {
                        if (editId) {
                            alert('Beneficiary updated successfully!');
                        } else {
                            alert('Beneficiary added successfully!');
                        }
                        $('#beneficiaryForm')[0].reset();
                        $('#beneficiaryForm').removeClass('was-validated');
                        $('#beneficiaryForm .is-invalid').removeClass('is-invalid');
                        $('#editId').val('');
                        $('#editBeneficiaryModal').modal('hide');
                        loadBeneficiaries(); // Reload beneficiaries after adding or updating
                    },
                    error: function(error) {
                        handleFormError(error);
                    }
                });
                $(this).addClass('was-validated');
            });
        });

        // Function to load all beneficiaries into the DataTable
        function loadBeneficiaries() {
            $.ajax({
                type: 'GET',
                url: '/api/beneficiaries',
                success: function(response) {
                    displayBeneficiaries(response.data);
                },
                error: function(error) {
                    console.error('Error fetching beneficiaries:', error);
                }
            });
        }

        // Function to display beneficiaries in the DataTable
        function displayBeneficiaries(beneficiaries) {
            var table = $('#beneficiariesTable').DataTable();
            table.clear().draw();
            
            beneficiaries.forEach(function(beneficiary) {
                var editButton = '<button type="button" class="btn btn-primary btn-sm editBtn" data-id="' + beneficiary._id + '">Edit</button>';
                var deleteButton = '<button type="button" class="btn btn-danger btn-sm deleteBtn" data-id="' + beneficiary._id + '">Delete</button>';
                table.row.add([
                    beneficiary.name,
                    '+234'+beneficiary.phone_no,
                    beneficiary.contact_address,
                    beneficiary.email_address ? beneficiary.email_address : '',
                    editButton + ' ' + deleteButton
                ]).draw(false);
            });

            // Bind edit and delete button events
            bindEditDeleteEvents();
        }

        // Function to bind edit and delete button events
        function bindEditDeleteEvents() {
            // Edit button click event
            $('.editBtn').click(function() {
                var beneficiaryId = $(this).attr('data-id');
                $.ajax({
                    type: 'GET',
                    url: '/api/beneficiaries/' + beneficiaryId,
                    success: function(response) {
                        $('#editId').val(response.data._id);
                        $('#name').val(response.data.name);
                        $('#phone_no').val(response.data.phone_no);
                        $('#contact_address').val(response.data.contact_address);
                        $('#email_address').val(response.data.email_address);
                        $('#editBeneficiaryModal').modal('show');
                    },
                    error: function(error) {
                        console.error('Error fetching beneficiary:', error);
                        alert('Error fetching beneficiary details. Please try again.');
                    }
                });
            });

            // Delete button click event
            $('.deleteBtn').click(function() {
                var beneficiaryId = $(this).attr('data-id');
                // Implement delete functionality
                if (confirm('Are you sure you want to delete this beneficiary?')) {
                    deleteBeneficiary(beneficiaryId);
                }
            });
        }

        // Function to delete a beneficiary
        function deleteBeneficiary(id) {
            $.ajax({
                type: 'DELETE',
                url: '/api/beneficiaries/' + id,
                success: function(response) {
                    alert('Beneficiary deleted successfully!');
                    loadBeneficiaries(); // Reload beneficiaries after deletion
                },
                error: function(error) {
                    console.error('Error deleting beneficiary:', error);
                    alert('Error deleting beneficiary. Please try again.');
                }
            });
        }

        // Function to handle form validation and display errors
        function handleFormError(error) {
            if (error.responseJSON && error.responseJSON.message) {
                var messages = error.responseJSON.message;
                if (typeof messages === 'string') {
                    alert(messages);
                } else if (Array.isArray(messages)) {
                    messages.forEach(function(message) {
                        alert(message);
                    });
                }
            } else {
                alert('An unexpected error occurred. Please try again.');
            }
        }
    </script>
</body>
</html>
