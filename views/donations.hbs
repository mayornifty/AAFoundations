<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donations Management</title>
    <!-- Include jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <!-- Include Bootstrap CSS for styling -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Include DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.css">
</head>
<body>
    <div class="container mt-5">
        <h1>General Support Donations</h1>

        <!-- Button to trigger modal -->
        <button type="button" class="btn btn-primary mb-3" data-toggle="modal" data-target="#donationModal">
            Add New Donation
        </button>
        
        <!-- Donations Table -->
        <table id="donationsTable" class="table table-striped">
            <thead>
                <tr>
                    <th>Start Date</th>
                    <th>Beneficiary</th>
                    <th>Designation</th>
                    <th>Account Number</th>
                    <th>Amount</th>
                    <th>Bank</th>
                    <th>Comments</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="donationsTableBody">
                <!-- Table rows will be dynamically populated -->
            </tbody>
        </table>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="donationModal" tabindex="-1" role="dialog" aria-labelledby="donationModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <form id="donationForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="donationModalLabel">Add New Donation</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="donationId" name="donationId"> <!-- Hidden input for donation ID -->
                        
                        <div class="form-row">
                            <div class="form-group col-md-4">
                                <label for="start_date">Start Date</label>
                                <input type="date" class="form-control" id="start_date" name="start_date" required>
                            </div>
                            <div class="form-group col-md-4">
                                <label for="beneficiary_id">Beneficiary</label>
                                <select class="form-control" id="beneficiary_id" name="beneficiary_id" required>
                                    <option value="">Select Beneficiary</option>
                                    <!-- Beneficiaries will be dynamically fetched -->
                                </select>
                            </div>
                            <div class="form-group col-md-4">
                                <label for="designation">Designation</label>
                                <input type="text" class="form-control" id="designation" name="designation" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-4">
                                <label for="account_no">Account Number</label>
                                <input type="text" class="form-control" id="account_no" name="account_no" required>
                            </div>
                            <div class="form-group col-md-4">
                                <label for="amount">Amount</label>
                                <input type="number" step="0.01" class="form-control" id="amount" name="amount" required>
                            </div>
                            <div class="form-group col-md-4">
                                <label for="bank">Bank</label>
                                <input type="text" class="form-control" id="bank" name="bank" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-12">
                                <label for="comments">Comments</label>
                                <textarea class="form-control" id="comments" name="comments" required></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary" id="saveChangesBtn">Add Donation</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Include Bootstrap JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- Include DataTables JS -->
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.js"></script>
    <script>
        // Function to fetch beneficiaries and populate dropdown
        function fetchBeneficiaries() {
            $.ajax({
                type: 'GET',
                url: '/api/beneficiaries',
                success: function(response) {
                    var beneficiaries = response.data;
                    var dropdown = $('#beneficiary_id');
                    dropdown.empty();
                    dropdown.append('<option value="">Select Beneficiary</option>');
                    $.each(beneficiaries, function(index, beneficiary) {
                        dropdown.append('<option value="' + beneficiary._id + '">' + beneficiary.name + '</option>');
                    });
                },
                error: function(error) {
                    console.error('Error fetching beneficiaries:', error);
                    alert('Error fetching beneficiaries. Please try again.');
                }
            });
        }

        // Function to fetch donations and display in the table
        function fetchDonations() {
            $.ajax({
                type: 'GET',
                url: '/api/donations',
                success: function(response) {
                    displayDonations(response.data);
                },
                error: function(error) {
                    console.error('Error fetching donations:', error);
                    alert('Error fetching donations. Please try again.');
                }
            });
        }

        // Function to display donations in the table
        function displayDonations(donations) {
            var table = $('#donationsTable').DataTable();
            table.clear().draw(); // Clear existing table and redraw

            donations.forEach(function(donation) {
                var amount = parseFloat(donation.amount.$numberDecimal).toFixed(2);

                // Fetch beneficiary name using AJAX
                $.ajax({
                    type: 'GET',
                    url: '/api/beneficiaries/' + donation.beneficiary_id,
                    success: function(response) {
                        var beneficiaryName = response.data.name;

                        var row = [
                            formatDate(donation.start_date),
                            beneficiaryName, // Display beneficiary name instead of ID
                            donation.designation,
                            donation.account_no,
                            amount,
                            donation.bank,
                            donation.comments,
                            '<button class="btn btn-sm btn-primary btn-edit" data-id="' + donation._id + '" disabled>Edit</button> ' +
                            '<button class="btn btn-sm btn-danger btn-delete" data-id="' + donation._id + '" disabled>Delete</button>'
                        ];
                        table.row.add(row).draw(false);
                    },
                    error: function(error) {
                        console.error('Error fetching beneficiary details:', error);
                        alert('Error fetching beneficiary details. Please try again.');
                    }
                });
            });
        }

        // Format date as "YYYY-MM-DD"
        function formatDate(dateString) {
            var date = new Date(dateString);
            return date.toISOString().split('T')[0];
        }

        // Call fetchBeneficiaries function on document ready
        $(document).ready(function() {
            fetchBeneficiaries(); // Fetch beneficiaries initially
            fetchDonations(); // Fetch donations initially

            // Initialize DataTables
            $('#donationsTable').DataTable();
        });

        // Submit Form Handling
        $('#donationForm').submit(function(event) {
            event.preventDefault();
            var donationId = $('#donationId').val();
            var url = '/api/donations';
            var method = 'POST';

            if (donationId) {
                url += '/' + donationId;
                method = 'PUT';
            }

            var formData = {
                start_date: $('#start_date').val(),
                beneficiary_id: $('#beneficiary_id').val(),
                designation: $('#designation').val(),
                account_no: $('#account_no').val(),
                amount: parseFloat($('#amount').val()),
                bank: $('#bank').val(),
                comments: $('#comments').val()
            };

            $.ajax({
                type: method,
                url: url,
                data: formData,
                success: function(response) {
                    alert('Donation ' + (donationId ? 'updated' : 'added') + ' successfully!');
                    fetchDonations(); // Refresh table after addition/update
                    $('#donationForm')[0].reset(); // Clear form fields
                    $('#donationId').val(''); // Reset donationId field
                    $('#donationModal').modal('hide'); // Close modal
                },
                error: function(error) {
                    console.error('Error saving donation:', error);
                    alert('Error saving donation. Please try again.');
                }
            });
        });

        // Edit and Delete Button Actions (Event Delegation)
        $('#donationsTable').on('click', '.btn-edit', function() {
            var donationId = $(this).attr('data-id');
            $.ajax({
                type: 'GET',
                url: '/api/donations/' + donationId,
                success: function(response) {
                    var donation = response.data;
                    $('#donationId').val(donation._id);
                    $('#start_date').val(formatDate(donation.start_date));
                    $('#beneficiary_id').val(donation.beneficiary_id);
                    $('#designation').val(donation.designation);
                    $('#account_no').val(donation.account_no);
                    $('#amount').val(parseFloat(donation.amount.$numberDecimal).toFixed(2));
                    $('#bank').val(donation.bank);
                    $('#comments').val(donation.comments);
                    $('#donationModal').modal('show');
                },
                error: function(error) {
                    console.error('Error fetching donation details:', error);
                    alert('Error fetching donation details. Please try again.');
                }
            });
        });

        $('#donationsTable').on('click', '.btn-delete', function() {
            var donationId = $(this).attr('data-id');
            if (confirm('Are you sure you want to delete this donation?')) {
                $.ajax({
                    type: 'DELETE',
                    url: '/api/donations/' + donationId,
                    success: function(response) {
                        alert('Donation deleted successfully!');
                        fetchDonations(); // Refresh table after deletion
                    },
                    error: function(error) {
                        console.error('Error deleting donation:', error);
                        alert('Error deleting donation. Please try again.');
                    }
                });
            }
        });
    </script>
</body>
</html>
